<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Circle Column Verification - Directory Page</title>
  <link rel="stylesheet" href="public/css/contacts-table.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f9fafb;
    }
    .test-container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #111827;
      margin-bottom: 10px;
    }
    .test-description {
      color: #6b7280;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    .test-section {
      margin-bottom: 40px;
    }
    .test-section h2 {
      color: #374151;
      font-size: 18px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e5e7eb;
    }
    .test-result {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 14px;
    }
    .test-result.pass {
      background: #d1fae5;
      border: 1px solid #a7f3d0;
      color: #065f46;
    }
    .test-result.fail {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }
    .test-result.info {
      background: #dbeafe;
      border: 1px solid #bfdbfe;
      color: #1e40af;
    }
    .test-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .test-btn {
      padding: 10px 20px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }
    .test-btn:hover {
      background: #2563eb;
    }
    .test-btn.secondary {
      background: #6b7280;
    }
    .test-btn.secondary:hover {
      background: #4b5563;
    }
    #search-filter-container {
      margin-bottom: 20px;
    }
    #contacts-table-container {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>üéØ Circle Column Verification</h1>
    <p class="test-description">
      This page verifies that the Circle column is properly implemented in the Contacts table,
      including rendering circle badges, sorting by circle, and filtering by circle.
      <br><strong>Requirements:</strong> 8.1, 8.2, 8.3, 8.4, 8.5
    </p>

    <!-- Test Controls -->
    <div class="test-section">
      <h2>Test Controls</h2>
      <div class="test-controls">
        <button class="test-btn" onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
        <button class="test-btn secondary" onclick="testCircleBadgeRendering()">Test Circle Badge Rendering</button>
        <button class="test-btn secondary" onclick="testCircleSorting()">Test Circle Sorting</button>
        <button class="test-btn secondary" onclick="testCircleFiltering()">Test Circle Filtering</button>
        <button class="test-btn secondary" onclick="resetTests()">üîÑ Reset</button>
      </div>
      <div id="test-results"></div>
    </div>

    <!-- Search Filter Bar -->
    <div class="test-section">
      <h2>Search & Filter (Test circle: filter)</h2>
      <div id="search-filter-container"></div>
    </div>

    <!-- Contacts Table -->
    <div class="test-section">
      <h2>Contacts Table with Circle Column</h2>
      <div id="contacts-table-container"></div>
    </div>
  </div>

  <script src="public/js/contacts-table.js"></script>
  <script>
    // Sample contacts with various circle assignments
    const sampleContacts = [
      {
        id: '1',
        name: 'Alice Johnson',
        email: 'alice@example.com',
        phone: '+1-555-0101',
        location: 'New York',
        timezone: 'America/New_York',
        frequencyPreference: 'weekly',
        dunbarCircle: 'inner',
        tags: [{ text: 'family' }],
        groups: ['group1'],
        source: 'manual',
        createdAt: '2024-01-15T10:00:00Z',
        lastInteractionAt: '2024-12-01T10:00:00Z'
      },
      {
        id: '2',
        name: 'Bob Smith',
        email: 'bob@example.com',
        phone: '+1-555-0102',
        location: 'San Francisco',
        timezone: 'America/Los_Angeles',
        frequencyPreference: 'biweekly',
        dunbarCircle: 'close',
        tags: [{ text: 'work' }],
        groups: ['group2'],
        source: 'google',
        createdAt: '2024-02-20T10:00:00Z',
        lastInteractionAt: '2024-11-28T10:00:00Z'
      },
      {
        id: '3',
        name: 'Carol Davis',
        email: 'carol@example.com',
        phone: '+1-555-0103',
        location: 'Chicago',
        timezone: 'America/Chicago',
        frequencyPreference: 'monthly',
        dunbarCircle: 'active',
        tags: [{ text: 'friend' }],
        groups: [],
        source: 'manual',
        createdAt: '2024-03-10T10:00:00Z',
        lastInteractionAt: '2024-11-20T10:00:00Z'
      },
      {
        id: '4',
        name: 'David Wilson',
        email: 'david@example.com',
        phone: '+1-555-0104',
        location: 'Austin',
        timezone: 'America/Chicago',
        frequencyPreference: 'quarterly',
        dunbarCircle: 'casual',
        tags: [{ text: 'colleague' }],
        groups: ['group2'],
        source: 'google',
        createdAt: '2024-04-05T10:00:00Z',
        lastInteractionAt: '2024-10-15T10:00:00Z'
      },
      {
        id: '5',
        name: 'Eve Martinez',
        email: 'eve@example.com',
        phone: '+1-555-0105',
        location: 'Seattle',
        timezone: 'America/Los_Angeles',
        frequencyPreference: 'quarterly',
        dunbarCircle: 'acquaintance',
        tags: [{ text: 'networking' }],
        groups: [],
        source: 'manual',
        createdAt: '2024-05-12T10:00:00Z',
        lastInteractionAt: '2024-09-10T10:00:00Z'
      },
      {
        id: '6',
        name: 'Frank Brown',
        email: 'frank@example.com',
        phone: '+1-555-0106',
        location: 'Boston',
        timezone: 'America/New_York',
        frequencyPreference: 'monthly',
        dunbarCircle: null, // Uncategorized
        tags: [],
        groups: [],
        source: 'manual',
        createdAt: '2024-06-18T10:00:00Z',
        lastInteractionAt: '2024-08-05T10:00:00Z'
      },
      {
        id: '7',
        name: 'Grace Lee',
        email: 'grace@example.com',
        phone: '+1-555-0107',
        location: 'Los Angeles',
        timezone: 'America/Los_Angeles',
        frequencyPreference: 'weekly',
        dunbarCircle: 'inner',
        tags: [{ text: 'family' }],
        groups: ['group1'],
        source: 'google',
        createdAt: '2024-07-22T10:00:00Z',
        lastInteractionAt: '2024-12-02T10:00:00Z'
      },
      {
        id: '8',
        name: 'Henry Taylor',
        email: 'henry@example.com',
        phone: '+1-555-0108',
        location: 'Denver',
        timezone: 'America/Denver',
        frequencyPreference: 'biweekly',
        dunbarCircle: 'close',
        tags: [{ text: 'friend' }],
        groups: [],
        source: 'manual',
        createdAt: '2024-08-30T10:00:00Z',
        lastInteractionAt: '2024-11-25T10:00:00Z'
      }
    ];

    let contactsTable;
    let searchFilterBar;

    // Initialize components
    function initializeComponents() {
      // Initialize SearchFilterBar
      searchFilterBar = new SearchFilterBar('search-filter-container', {
        onSearch: (text, filters) => {
          console.log('Search:', text, 'Filters:', filters);
          const filtered = searchFilterBar.applyFilters(sampleContacts, text, filters);
          contactsTable.refresh(filtered);
        },
        onFetchTags: async () => {
          const tags = new Set();
          sampleContacts.forEach(c => {
            if (c.tags) c.tags.forEach(t => tags.add(t.text));
          });
          return Array.from(tags);
        },
        onFetchGroups: async () => {
          return [
            { id: 'group1', name: 'Family' },
            { id: 'group2', name: 'Work' }
          ];
        }
      });
      searchFilterBar.render();

      // Initialize ContactsTable
      contactsTable = new ContactsTable('contacts-table-container', sampleContacts, {
        sortBy: 'name',
        sortOrder: 'asc',
        onEdit: (contactId, field, value) => {
          console.log('Edit:', contactId, field, value);
        },
        onDelete: (contactId) => {
          console.log('Delete:', contactId);
        },
        onAdd: (contact) => {
          console.log('Add:', contact);
        }
      });
      contactsTable.render();
    }

    // Test Functions
    function addTestResult(message, type = 'info') {
      const resultsDiv = document.getElementById('test-results');
      const resultEl = document.createElement('div');
      resultEl.className = `test-result ${type}`;
      resultEl.textContent = message;
      resultsDiv.appendChild(resultEl);
    }

    function clearTestResults() {
      document.getElementById('test-results').innerHTML = '';
    }

    function testCircleBadgeRendering() {
      clearTestResults();
      addTestResult('Testing Circle Badge Rendering...', 'info');

      let passed = 0;
      let failed = 0;

      // Test 1: Check if Circle column exists in header
      const circleHeader = document.querySelector('th[data-column="circle"]');
      if (circleHeader) {
        addTestResult('‚úì Circle column header found', 'pass');
        passed++;
      } else {
        addTestResult('‚úó Circle column header NOT found', 'fail');
        failed++;
      }

      // Test 2: Check if circle badges are rendered for contacts with circles
      const innerCircleContacts = sampleContacts.filter(c => c.dunbarCircle === 'inner');
      const innerBadges = document.querySelectorAll('.badge-circle');
      if (innerBadges.length > 0) {
        addTestResult(`‚úì Found ${innerBadges.length} circle badges`, 'pass');
        passed++;
      } else {
        addTestResult('‚úó No circle badges found', 'fail');
        failed++;
      }

      // Test 3: Check if uncategorized badge is shown for contacts without circles
      const uncategorizedBadges = document.querySelectorAll('.badge-uncategorized');
      if (uncategorizedBadges.length > 0) {
        addTestResult(`‚úì Found ${uncategorizedBadges.length} uncategorized badges`, 'pass');
        passed++;
      } else {
        addTestResult('‚úó No uncategorized badges found', 'fail');
        failed++;
      }

      // Test 4: Check if circle badges have correct colors
      const circleBadge = document.querySelector('.badge-circle');
      if (circleBadge) {
        const bgColor = circleBadge.style.backgroundColor;
        if (bgColor) {
          addTestResult(`‚úì Circle badge has background color: ${bgColor}`, 'pass');
          passed++;
        } else {
          addTestResult('‚úó Circle badge missing background color', 'fail');
          failed++;
        }
      }

      // Summary
      addTestResult(`\nCircle Badge Rendering: ${passed} passed, ${failed} failed`, passed > failed ? 'pass' : 'fail');
    }

    function testCircleSorting() {
      clearTestResults();
      addTestResult('Testing Circle Sorting...', 'info');

      let passed = 0;
      let failed = 0;

      // Test 1: Sort by circle ascending
      contactsTable.sort('circle', 'asc');
      const rows = document.querySelectorAll('.contacts-table tbody tr:not(.empty-state)');
      
      if (rows.length > 0) {
        addTestResult(`‚úì Table has ${rows.length} rows after sorting`, 'pass');
        passed++;

        // Check if first contact is inner circle
        const firstCircleBadge = rows[0].querySelector('.contact-circle');
        if (firstCircleBadge) {
          const badgeText = firstCircleBadge.textContent.trim();
          if (badgeText.includes('Inner Circle')) {
            addTestResult('‚úì First contact is Inner Circle (correct sort order)', 'pass');
            passed++;
          } else {
            addTestResult(`‚úó First contact is "${badgeText}", expected Inner Circle`, 'fail');
            failed++;
          }
        }

        // Check if last contact is uncategorized
        const lastCircleBadge = rows[rows.length - 1].querySelector('.contact-circle');
        if (lastCircleBadge) {
          const badgeText = lastCircleBadge.textContent.trim();
          if (badgeText.includes('Uncategorized') || badgeText.includes('Acquaintances')) {
            addTestResult('‚úì Last contact is Uncategorized or Acquaintances (correct sort order)', 'pass');
            passed++;
          } else {
            addTestResult(`‚úó Last contact is "${badgeText}", expected Uncategorized or Acquaintances`, 'fail');
            failed++;
          }
        }
      } else {
        addTestResult('‚úó No rows found after sorting', 'fail');
        failed++;
      }

      // Test 2: Check sort indicator
      const sortIndicator = document.querySelector('th[data-column="circle"] .sort-indicator');
      if (sortIndicator && sortIndicator.textContent.includes('‚ñ≤')) {
        addTestResult('‚úì Sort indicator shows ascending arrow', 'pass');
        passed++;
      } else {
        addTestResult('‚úó Sort indicator not showing correctly', 'fail');
        failed++;
      }

      // Summary
      addTestResult(`\nCircle Sorting: ${passed} passed, ${failed} failed`, passed > failed ? 'pass' : 'fail');
    }

    function testCircleFiltering() {
      clearTestResults();
      addTestResult('Testing Circle Filtering...', 'info');

      let passed = 0;
      let failed = 0;

      // Test 1: Filter by inner circle
      searchFilterBar.setQuery('circle:inner');
      
      setTimeout(() => {
        const rows = document.querySelectorAll('.contacts-table tbody tr:not(.empty-state)');
        const innerCount = sampleContacts.filter(c => c.dunbarCircle === 'inner').length;
        
        if (rows.length === innerCount) {
          addTestResult(`‚úì Filtered to ${rows.length} Inner Circle contacts (expected ${innerCount})`, 'pass');
          passed++;
        } else {
          addTestResult(`‚úó Found ${rows.length} contacts, expected ${innerCount}`, 'fail');
          failed++;
        }

        // Test 2: Check if filter chip is displayed
        const filterChip = document.querySelector('.filter-chip');
        if (filterChip && filterChip.textContent.includes('circle') && filterChip.textContent.includes('inner')) {
          addTestResult('‚úì Filter chip displayed correctly', 'pass');
          passed++;
        } else {
          addTestResult('‚úó Filter chip not displayed correctly', 'fail');
          failed++;
        }

        // Test 3: Clear filter
        searchFilterBar.clearFilters();
        
        setTimeout(() => {
          const allRows = document.querySelectorAll('.contacts-table tbody tr:not(.empty-state)');
          if (allRows.length === sampleContacts.length) {
            addTestResult(`‚úì Filter cleared, showing all ${allRows.length} contacts`, 'pass');
            passed++;
          } else {
            addTestResult(`‚úó After clearing, found ${allRows.length} contacts, expected ${sampleContacts.length}`, 'fail');
            failed++;
          }

          // Summary
          addTestResult(`\nCircle Filtering: ${passed} passed, ${failed} failed`, passed > failed ? 'pass' : 'fail');
        }, 100);
      }, 100);
    }

    function runAllTests() {
      clearTestResults();
      addTestResult('Running all Circle column tests...', 'info');
      
      testCircleBadgeRendering();
      
      setTimeout(() => {
        testCircleSorting();
      }, 500);
      
      setTimeout(() => {
        testCircleFiltering();
      }, 1000);
    }

    function resetTests() {
      clearTestResults();
      searchFilterBar.clearFilters();
      contactsTable.sort('name', 'asc');
      addTestResult('Tests reset. Table sorted by name.', 'info');
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      initializeComponents();
      addTestResult('Components initialized. Click "Run All Tests" to verify Circle column functionality.', 'info');
    });
  </script>
</body>
</html>

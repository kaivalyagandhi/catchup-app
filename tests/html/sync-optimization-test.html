<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sync Optimization Testing - CatchUp</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f0;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #2c2c2c;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }

    .section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .section h2 {
      color: #2c2c2c;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .test-group {
      margin-bottom: 20px;
    }

    .test-group h3 {
      color: #555;
      font-size: 16px;
      margin-bottom: 10px;
    }

    button {
      background: #4a90e2;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    button:hover {
      background: #357abd;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .result {
      background: #f8f9fa;
      border-left: 4px solid #4a90e2;
      padding: 15px;
      margin-top: 10px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow-y: auto;
    }

    .result.success {
      border-left-color: #28a745;
      background: #f0f9f4;
    }

    .result.error {
      border-left-color: #dc3545;
      background: #fff5f5;
    }

    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .status.warning {
      background: #fff3cd;
      color: #856404;
    }

    input[type="text"] {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 300px;
      margin-right: 10px;
    }

    .info-box {
      background: #e7f3ff;
      border-left: 4px solid #4a90e2;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }

    .info-box strong {
      display: block;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÑ Google Sync Optimization Testing</h1>
    <p class="subtitle">Interactive testing for all sync optimization features</p>

    <div class="info-box">
      <strong>‚ö†Ô∏è Important:</strong>
      You need to be logged in to test these features. Open the app in another tab, login, and then come back here.
      The JWT token will be automatically retrieved from localStorage.
    </p>

    <!-- Authentication Section -->
    <div class="section">
      <h2>üîê Authentication</h2>
      <div class="test-group">
        <button onclick="checkAuth()">Check Authentication Status</button>
        <button onclick="loginPrompt()">Login Instructions</button>
        <div id="auth-result"></div>
      </div>
    </div>

    <!-- Manual Sync Testing -->
    <div class="section">
      <h2>üîÑ Manual Sync Testing</h2>
      
      <div class="test-group">
        <h3>Trigger Manual Sync</h3>
        <button onclick="triggerManualSync('contacts')">Sync Contacts</button>
        <button onclick="triggerManualSync('calendar')">Sync Calendar</button>
        <div id="manual-sync-result"></div>
      </div>

      <div class="test-group">
        <h3>Test Rate Limiting</h3>
        <button onclick="testRateLimit()">Trigger Multiple Syncs (Test Rate Limit)</button>
        <div id="rate-limit-result"></div>
      </div>
    </div>

    <!-- Admin Dashboard Testing -->
    <div class="section">
      <h2>üìä Admin Dashboard Testing</h2>
      
      <div class="test-group">
        <h3>Fetch Sync Health Metrics</h3>
        <button onclick="fetchSyncHealth()">Get All Metrics</button>
        <button onclick="fetchSyncHealth('google_contacts')">Get Contacts Metrics</button>
        <button onclick="fetchSyncHealth('google_calendar')">Get Calendar Metrics</button>
        <div id="sync-health-result"></div>
      </div>

      <div class="test-group">
        <h3>Open Admin Dashboard</h3>
        <button onclick="openAdminDashboard()">Open Dashboard in New Tab</button>
      </div>
    </div>

    <!-- Database Inspection -->
    <div class="section">
      <h2>üóÑÔ∏è Database Inspection</h2>
      <p style="color: #666; margin-bottom: 15px;">
        These tests show what's in the database. Run manual syncs first to populate data.
      </p>
      
      <div class="test-group">
        <h3>Check Database Tables</h3>
        <button onclick="checkDatabaseTables()">Check All Tables</button>
        <div id="db-result"></div>
      </div>
    </div>

    <!-- Server Logs -->
    <div class="section">
      <h2>üìù Server Logs</h2>
      <p style="color: #666; margin-bottom: 15px;">
        Check your terminal where the server is running to see detailed logs for:
      </p>
      <ul style="margin-left: 20px; color: #666;">
        <li>[TokenHealthMonitor] - Token validation logs</li>
        <li>[CircuitBreaker] - Circuit breaker state transitions</li>
        <li>[AdaptiveSyncScheduler] - Frequency adjustments</li>
        <li>[SyncOrchestrator] - Sync execution logs</li>
      </ul>
    </div>
  </div>

  <script>
    // Get JWT token from localStorage
    function getToken() {
      return localStorage.getItem('token');
    }

    // Check authentication status
    function checkAuth() {
      const token = getToken();
      const resultDiv = document.getElementById('auth-result');
      
      if (token) {
        resultDiv.innerHTML = `<div class="result success">‚úì JWT Token found in localStorage<br>Token: ${token.substring(0, 50)}...</div>`;
      } else {
        resultDiv.innerHTML = `<div class="result error">‚úó No JWT token found. Please login first.<br><br>1. Open http://localhost:3000 in another tab<br>2. Login with your account<br>3. Come back to this page</div>`;
      }
    }

    // Login instructions
    function loginPrompt() {
      const resultDiv = document.getElementById('auth-result');
      resultDiv.innerHTML = `<div class="result">
<strong>Login Instructions:</strong>

1. Open http://localhost:3000 in a new tab
2. Click "Sign in with Google" or login with your credentials
3. After successful login, come back to this page
4. Click "Check Authentication Status" to verify

The JWT token will be automatically available in localStorage.
      </div>`;
    }

    // Trigger manual sync
    async function triggerManualSync(integrationType) {
      const token = getToken();
      const resultDiv = document.getElementById('manual-sync-result');
      
      if (!token) {
        resultDiv.innerHTML = `<div class="result error">Please login first</div>`;
        return;
      }

      resultDiv.innerHTML = `<div class="result">Triggering ${integrationType} sync...</div>`;

      try {
        const response = await fetch('/api/sync/manual', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ integration_type: integrationType })
        });

        const data = await response.json();
        const isSuccess = response.ok;
        
        resultDiv.innerHTML = `<div class="result ${isSuccess ? 'success' : 'error'}">
<strong>Response (${response.status}):</strong>
${JSON.stringify(data, null, 2)}
        </div>`;
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
      }
    }

    // Test rate limiting
    async function testRateLimit() {
      const token = getToken();
      const resultDiv = document.getElementById('rate-limit-result');
      
      if (!token) {
        resultDiv.innerHTML = `<div class="result error">Please login first</div>`;
        return;
      }

      resultDiv.innerHTML = `<div class="result">Testing rate limiting (triggering 2 syncs rapidly)...</div>`;

      try {
        // First request
        const response1 = await fetch('/api/sync/manual', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ integration_type: 'contacts' })
        });
        const data1 = await response1.json();

        // Second request (should be rate limited)
        const response2 = await fetch('/api/sync/manual', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ integration_type: 'contacts' })
        });
        const data2 = await response2.json();

        resultDiv.innerHTML = `<div class="result">
<strong>First Request (${response1.status}):</strong>
${JSON.stringify(data1, null, 2)}

<strong>Second Request (${response2.status}):</strong>
${JSON.stringify(data2, null, 2)}

${response2.status === 429 ? '<strong style="color: #28a745;">‚úì Rate limiting is working!</strong>' : '<strong style="color: #dc3545;">‚úó Rate limiting may not be working</strong>'}
        </div>`;
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
      }
    }

    // Fetch sync health metrics
    async function fetchSyncHealth(integrationType = null) {
      const token = getToken();
      const resultDiv = document.getElementById('sync-health-result');
      
      if (!token) {
        resultDiv.innerHTML = `<div class="result error">Please login first</div>`;
        return;
      }

      const url = integrationType 
        ? `/api/admin/sync-health?integration_type=${integrationType}`
        : '/api/admin/sync-health';

      resultDiv.innerHTML = `<div class="result">Fetching sync health metrics...</div>`;

      try {
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();
        const isSuccess = response.ok;
        
        resultDiv.innerHTML = `<div class="result ${isSuccess ? 'success' : 'error'}">
<strong>Response (${response.status}):</strong>
${JSON.stringify(data, null, 2)}
        </div>`;
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
      }
    }

    // Open admin dashboard
    function openAdminDashboard() {
      window.open('/admin/sync-health.html', '_blank');
    }

    // Check database tables (mock - would need backend endpoint)
    function checkDatabaseTables() {
      const resultDiv = document.getElementById('db-result');
      resultDiv.innerHTML = `<div class="result">
<strong>Database Tables to Check:</strong>

Run these commands in your terminal:

# Check token health
psql -h localhost -U postgres -d catchup_db -c "SELECT * FROM token_health LIMIT 5;"

# Check circuit breaker states
psql -h localhost -U postgres -d catchup_db -c "SELECT * FROM circuit_breaker_state LIMIT 5;"

# Check sync schedules
psql -h localhost -U postgres -d catchup_db -c "SELECT * FROM sync_schedule LIMIT 5;"

# Check sync metrics
psql -h localhost -U postgres -d catchup_db -c "SELECT * FROM sync_metrics ORDER BY created_at DESC LIMIT 5;"

# Check webhook subscriptions
psql -h localhost -U postgres -d catchup_db -c "SELECT * FROM calendar_webhook_subscriptions LIMIT 5;"
      </div>`;
    }

    // Auto-check auth on page load
    window.addEventListener('load', () => {
      checkAuth();
    });
  </script>
</body>
</html>

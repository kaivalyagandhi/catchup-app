<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Privacy Features Test - CatchUp</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      background: #f5f5f5;
    }

    h1 {
      color: #2c3e50;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #7f8c8d;
      margin-bottom: 2rem;
    }

    .test-section {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .test-section h2 {
      color: #2c3e50;
      margin-bottom: 1rem;
      border-bottom: 2px solid #3498db;
      padding-bottom: 0.5rem;
    }

    .test-controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover {
      background: #7f8c8d;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .test-output {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 1rem;
      margin-top: 1rem;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .success {
      color: #27ae60;
      font-weight: 500;
    }

    .error {
      color: #e74c3c;
      font-weight: 500;
    }

    .info {
      color: #3498db;
      font-weight: 500;
    }

    .demo-container {
      margin-top: 2rem;
      min-height: 400px;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      color: #7f8c8d;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .tab.active {
      color: #3498db;
      border-bottom-color: #3498db;
    }

    .tab:hover {
      color: #2c3e50;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <h1>Privacy Features Test</h1>
  <p class="subtitle">Test privacy notice, data export, and account deletion features</p>

  <!-- API Tests -->
  <div class="test-section">
    <h2>API Tests</h2>
    <div class="test-controls">
      <button class="btn btn-primary" onclick="testGetPrivacyNotice()">Get Privacy Notice</button>
      <button class="btn btn-primary" onclick="testGetDataSummary()">Get Data Summary</button>
      <button class="btn btn-primary" onclick="testExportData()">Export Data</button>
      <button class="btn btn-secondary" onclick="testVerifyIsolation()">Verify Data Isolation</button>
      <button class="btn btn-danger" onclick="testDeleteAccount()">Test Delete Account (Dry Run)</button>
    </div>
    <div id="api-output" class="test-output">
      API test results will appear here...
    </div>
  </div>

  <!-- Component Demos -->
  <div class="test-section">
    <h2>Component Demos</h2>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab('privacy-notice')">Privacy Notice</button>
      <button class="tab" onclick="switchTab('privacy-settings')">Privacy Settings</button>
    </div>

    <div id="privacy-notice-tab" class="tab-content active">
      <div class="test-controls">
        <button class="btn btn-primary" onclick="showPrivacyNotice()">Show Privacy Notice</button>
        <button class="btn btn-secondary" onclick="clearDemo()">Clear</button>
      </div>
      <div id="privacy-notice-demo" class="demo-container"></div>
    </div>

    <div id="privacy-settings-tab" class="tab-content">
      <div class="test-controls">
        <button class="btn btn-primary" onclick="showPrivacySettings()">Show Privacy Settings</button>
        <button class="btn btn-secondary" onclick="clearDemo()">Clear</button>
      </div>
      <div id="privacy-settings-demo" class="demo-container"></div>
    </div>
  </div>

  <!-- Load components -->
  <script src="/js/privacy-notice.js"></script>
  <script src="/js/privacy-settings.js"></script>

  <script>
    // Mock auth token for testing
    const TEST_AUTH_TOKEN = 'test-token-123';
    localStorage.setItem('auth_token', TEST_AUTH_TOKEN);

    function log(message, type = 'info') {
      const output = document.getElementById('api-output');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }

    async function testGetPrivacyNotice() {
      log('Testing GET /api/privacy/notice...');
      try {
        const response = await fetch('/api/privacy/notice');
        const data = await response.json();
        
        if (response.ok) {
          log('✓ Privacy notice retrieved successfully', 'success');
          log(`Notice length: ${data.notice.length} characters`);
        } else {
          log(`✗ Failed: ${data.error}`, 'error');
        }
      } catch (error) {
        log(`✗ Error: ${error.message}`, 'error');
      }
    }

    async function testGetDataSummary() {
      log('Testing GET /api/privacy/data-summary...');
      try {
        const response = await fetch('/api/privacy/data-summary', {
          headers: {
            'Authorization': `Bearer ${TEST_AUTH_TOKEN}`
          }
        });
        const data = await response.json();
        
        if (response.ok) {
          log('✓ Data summary retrieved successfully', 'success');
          log(JSON.stringify(data, null, 2));
        } else {
          log(`✗ Failed: ${data.error}`, 'error');
        }
      } catch (error) {
        log(`✗ Error: ${error.message}`, 'error');
      }
    }

    async function testExportData() {
      log('Testing POST /api/privacy/export...');
      try {
        const response = await fetch('/api/privacy/export', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${TEST_AUTH_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            includeContacts: true,
            includeInteractions: true,
            includeVoiceNotes: true
          })
        });
        const data = await response.json();
        
        if (response.ok) {
          log('✓ Data export successful', 'success');
          log(`Export date: ${data.exportDate}`);
          log(`Contacts: ${data.contacts?.length || 0}`);
          log(`Interactions: ${data.interactions?.length || 0}`);
          log(`Voice notes: ${data.voiceNotes?.length || 0}`);
        } else {
          log(`✗ Failed: ${data.error}`, 'error');
        }
      } catch (error) {
        log(`✗ Error: ${error.message}`, 'error');
      }
    }

    async function testVerifyIsolation() {
      log('Testing POST /api/privacy/verify-isolation...');
      try {
        const response = await fetch('/api/privacy/verify-isolation', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${TEST_AUTH_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            resourceId: 'test-resource-id',
            resourceType: 'contact'
          })
        });
        const data = await response.json();
        
        if (response.ok) {
          log('✓ Data isolation verified', 'success');
          log(`Is owner: ${data.isOwner}`);
        } else {
          log(`✗ Failed: ${data.error}`, 'error');
        }
      } catch (error) {
        log(`✗ Error: ${error.message}`, 'error');
      }
    }

    async function testDeleteAccount() {
      log('Testing DELETE /api/privacy/account (dry run)...');
      log('⚠️ This is a test - no actual deletion will occur', 'info');
      
      // Don't actually call the API in test mode
      log('✓ Test completed - API not called to prevent accidental deletion', 'success');
      log('To test deletion, use the Privacy Settings component with proper confirmation');
    }

    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    async function showPrivacyNotice() {
      const container = document.getElementById('privacy-notice-demo');
      container.innerHTML = '<div id="privacy-notice-container"></div>';

      const notice = new PrivacyNotice();
      await notice.init({
        onAccept: () => {
          alert('Privacy notice accepted!');
          log('✓ User accepted privacy notice', 'success');
        },
        onDecline: () => {
          alert('Privacy notice declined');
          log('User declined privacy notice', 'info');
        }
      });
      notice.render('privacy-notice-container');
    }

    function showPrivacySettings() {
      const container = document.getElementById('privacy-settings-demo');
      container.innerHTML = '<div id="privacy-settings-container"></div>';

      const settings = new PrivacySettings();
      settings.render('privacy-settings-container');
    }

    function clearDemo() {
      const activeTab = document.querySelector('.tab-content.active');
      const demoContainer = activeTab.querySelector('.demo-container');
      if (demoContainer) {
        demoContainer.innerHTML = '';
      }
    }

    // Initial log
    log('Privacy features test page loaded. Click buttons to test functionality.');
  </script>
</body>
</html>

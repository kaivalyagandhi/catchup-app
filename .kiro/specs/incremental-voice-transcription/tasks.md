# Implementation Plan

- [ ] 1. Enhance AudioManager with pause/resume and level detection
  - [ ] 1.1 Create AudioManager class with start/pause/resume/stop lifecycle
    - Implement MediaRecorder wrapper with state management
    - Add elapsed time tracking excluding paused duration
    - Implement audio chunk buffering with configurable interval (100ms)
    - _Requirements: 6.1, 6.2, 7.1_
  - [ ]* 1.2 Write property test for pause/resume transcript preservation
    - **Property 7: Pause/resume transcript round-trip**
    - **Validates: Requirements 6.1, 6.2, 6.5**
  - [ ] 1.3 Implement audio level detection and warnings
    - Add Web Audio API analyzer for real-time level monitoring
    - Implement silence detection with 3-second threshold
    - Add low-level warning (< -40dB) and clipping detection (>= 0dB)
    - _Requirements: 4.3, 4.4, 4.5_
  - [ ]* 1.4 Write property test for audio level warnings
    - **Property 4: Audio level warning accuracy**
    - **Validates: Requirements 4.4, 4.5**
  - [ ]* 1.5 Write property test for silence detection
    - **Property 3: Silence detection threshold**
    - **Validates: Requirements 4.3**
  - [ ] 1.6 Implement memory buffer management
    - Track buffer size in bytes
    - Flush oldest segments when approaching 100MB limit
    - _Requirements: 7.4_
  - [ ]* 1.7 Write property test for memory buffer bounds
    - **Property 9: Memory buffer bounds**
    - **Validates: Requirements 7.4**

- [ ] 2. Implement persistent RecordingIndicator component
  - [ ] 2.1 Create fixed-position recording indicator UI
    - Build floating indicator with recording/paused states
    - Add pulsing animation for active recording
    - Display elapsed time counter
    - Show connection status (connected/reconnecting/disconnected)
    - _Requirements: 3.1, 3.2, 3.3, 5.4_
  - [ ]* 2.2 Write property test for elapsed time accuracy
    - **Property 12: Elapsed time accuracy**
    - **Validates: Requirements 3.2**
  - [ ] 2.3 Implement navigation warning dialog
    - Add beforeunload handler during recording
    - Show confirmation dialog when navigating away
    - _Requirements: 3.4_
  - [ ] 2.4 Implement tab focus/blur handling
    - Continue recording when tab loses focus
    - Show notification when focus returns
    - _Requirements: 3.5_

- [ ] 3. Build TranscriptManager for interim/final text handling
  - [ ] 3.1 Create TranscriptManager class with segment-based state
    - Implement addInterimText and finalizeText methods
    - Track segments with id, text, isFinal, confidence, timestamp
    - Implement pause marker insertion
    - _Requirements: 1.3, 1.4, 6.5_
  - [ ]* 3.2 Write property test for final transcript preservation
    - **Property 1: Final transcript preservation**
    - **Validates: Requirements 1.3, 1.4**
  - [ ] 3.3 Implement confidence-based text rendering
    - Style text differently based on confidence levels
    - Low (< 0.7): lighter color, Medium (0.7-0.9): normal, High (>= 0.9): bold
    - _Requirements: 1.5_
  - [ ]* 3.4 Write property test for confidence-based styling
    - **Property 14: Confidence-based text styling**
    - **Validates: Requirements 1.5**

- [ ] 4. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [ ] 5. Enhance WebSocket handler for real-time streaming
  - [ ] 5.1 Update WebSocket message types for incremental updates
    - Add pause_session and resume_session client messages
    - Add enrichment_update and connection_status server messages
    - Update existing handlers for new message flow
    - _Requirements: 1.1, 2.2_
  - [ ]* 5.2 Write property test for streaming latency
    - **Property 13: Streaming latency bound**
    - **Validates: Requirements 1.1**
  - [ ] 5.3 Implement reconnection with exponential backoff
    - Add connection state tracking on client
    - Implement backoff delays: 1s, 2s, 4s (max 10s)
    - Buffer audio during disconnection
    - _Requirements: 5.1, 5.2_
  - [ ]* 5.4 Write property test for reconnection backoff timing
    - **Property 5: Reconnection backoff timing**
    - **Validates: Requirements 5.1**
  - [ ]* 5.5 Write property test for buffer integrity after reconnect
    - **Property 6: Buffer integrity after reconnect**
    - **Validates: Requirements 5.2, 5.5**
  - [ ] 5.6 Implement binary frame audio streaming
    - Send audio chunks as binary WebSocket frames
    - Handle binary data on server side
    - _Requirements: 7.1_

- [ ] 6. Create IncrementalEnrichmentAnalyzer service
  - [ ] 6.1 Implement enrichment trigger logic
    - Track word count and detect natural pauses
    - Trigger analysis at 50+ words or 2+ second pause
    - Debounce rapid triggers
    - _Requirements: 2.1_
  - [ ]* 6.2 Write property test for enrichment trigger threshold
    - **Property 11: Enrichment trigger threshold**
    - **Validates: Requirements 2.1**
  - [ ] 6.3 Implement suggestion merging and deduplication
    - Merge new suggestions with existing ones
    - Deduplicate by type and value
    - Keep highest confidence version
    - _Requirements: 2.3, 2.4_
  - [ ]* 6.4 Write property test for suggestion merge consistency
    - **Property 2: Suggestion merge consistency**
    - **Validates: Requirements 2.3, 2.4**
  - [ ] 6.5 Integrate with existing EntityExtractionService
    - Call extraction service with accumulated transcript
    - Map extraction results to EnrichmentSuggestion format
    - _Requirements: 2.2_

- [ ] 7. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [ ] 8. Build frontend enrichment panel for progressive suggestions
  - [ ] 8.1 Create EnrichmentPanel component
    - Display suggestions grouped by type (tags, notes, interests)
    - Show confidence indicators
    - Update dynamically as new suggestions arrive
    - _Requirements: 2.2_
  - [ ] 8.2 Implement suggestion animation and transitions
    - Animate new suggestions appearing
    - Highlight recently added suggestions
    - Smooth transitions when suggestions merge
    - _Requirements: 2.3_

- [ ] 9. Update VoiceNoteService for incremental processing
  - [ ] 9.1 Add pause/resume session methods
    - Implement pauseSession and resumeSession
    - Track paused duration in session state
    - _Requirements: 6.1, 6.2_
  - [ ] 9.2 Implement pause timeout handling
    - Start 5-minute timer when paused
    - Emit timeout event to prompt user
    - _Requirements: 6.4_
  - [ ]* 9.3 Write property test for pause timeout trigger
    - **Property 8: Pause timeout trigger**
    - **Validates: Requirements 6.4**
  - [ ] 9.4 Add long recording segmentation
    - Detect recordings exceeding 10 minutes
    - Segment audio for processing
    - _Requirements: 7.5_
  - [ ]* 9.5 Write property test for long recording segmentation
    - **Property 10: Long recording segmentation**
    - **Validates: Requirements 7.5**

- [ ] 10. Integrate all components in voice-notes.js
  - [ ] 10.1 Refactor VoiceNoteRecorder to use new components
    - Replace inline audio handling with AudioManager
    - Integrate TranscriptManager for display
    - Add RecordingIndicator to UI
    - _Requirements: 1.1, 1.2, 3.1_
  - [ ] 10.2 Connect WebSocket for real-time transcription
    - Enable WebSocket streaming (currently disabled)
    - Handle interim and final transcript messages
    - Display enrichment updates in EnrichmentPanel
    - _Requirements: 1.2, 1.3, 2.2_
  - [ ] 10.3 Implement pause/resume UI controls
    - Add pause button during recording
    - Show resume button when paused
    - Update indicator state
    - _Requirements: 6.1, 6.2, 6.3_
  - [ ] 10.4 Add audio visualization enhancements
    - Integrate level detection warnings
    - Show silence hint after 3 seconds
    - Display low volume and clipping warnings
    - _Requirements: 4.1, 4.3, 4.4, 4.5_

- [ ] 11. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
